name: Version Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Monday at 9:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch:

jobs:
  check-remotion-versions:
    name: Check Remotion Versions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check Remotion versions consistency
        run: |
          echo "Checking @remotion/* package versions..."

          # Get all @remotion packages from root package.json
          remotion_packages=$(cat package.json | grep -E '"@remotion/[^"]+":' | sed 's/.*"@remotion\/\([^"]*\)": "\([^"]*\)".*/\1:\2/')

          # Extract unique versions
          versions=$(echo "$remotion_packages" | cut -d: -f2 | sort -u)
          version_count=$(echo "$versions" | wc -l)

          echo "Found $version_count unique version(s):"
          echo "$versions"

          if [ "$version_count" -gt 1 ]; then
            echo ""
            echo "âš ï¸  WARNING: Multiple Remotion versions detected!"
            echo ""
            echo "All @remotion/* packages should use the same version."
            echo ""
            echo "Packages by version:"
            for version in $versions; do
              echo ""
              echo "Version $version:"
              echo "$remotion_packages" | grep ":$version$" | cut -d: -f1 | sed 's/^/  - @remotion\//'
            done
            exit 1
          else
            echo ""
            echo "âœ“ All @remotion/* packages use the same version: $versions"
          fi

      - name: Check for Remotion updates
        id: check-updates
        continue-on-error: true
        run: |
          echo "Checking for Remotion updates..."

          current_version=$(cat package.json | grep '"@remotion/cli":' | sed 's/.*": "\([^"]*\)".*/\1/')
          echo "Current version: $current_version"

          latest_version=$(npm view remotion version)
          echo "Latest version: $latest_version"

          echo "current=$current_version" >> $GITHUB_OUTPUT
          echo "latest=$latest_version" >> $GITHUB_OUTPUT

          if [ "$current_version" != "$latest_version" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo ""
            echo "ðŸ“¦ New Remotion version available: $latest_version (current: $current_version)"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo ""
            echo "âœ“ You are using the latest Remotion version"
          fi

      - name: Create issue for outdated version
        if: steps.check-updates.outputs.update_available == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.check-updates.outputs.current }}';
            const latest = '${{ steps.check-updates.outputs.latest }}';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,remotion'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Update Remotion')
            );

            if (existingIssue) {
              console.log('Issue already exists:', existingIssue.html_url);
              return;
            }

            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Update Remotion to ${latest}`,
              body: `## ðŸ“¦ Remotion Update Available\n\n` +
                    `A new version of Remotion is available.\n\n` +
                    `- **Current version:** ${current}\n` +
                    `- **Latest version:** ${latest}\n\n` +
                    `### Update instructions\n\n` +
                    `\`\`\`bash\n` +
                    `# Update all @remotion/* packages\n` +
                    `pnpm up -r "@remotion/*@${latest}"\n\n` +
                    `# Verify versions\n` +
                    `pnpm remotion versions\n` +
                    `\`\`\`\n\n` +
                    `See [Remotion Changelog](https://github.com/remotion-dev/remotion/releases) for details.`,
              labels: ['dependencies', 'remotion', 'automated']
            });

  check-dependencies:
    name: Check Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.20.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check for outdated dependencies
        run: |
          echo "Checking for outdated dependencies..."
          pnpm outdated || true

      - name: Audit dependencies
        run: |
          echo "Auditing dependencies for security issues..."
          pnpm audit --audit-level=moderate || true
